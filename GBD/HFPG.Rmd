# High Fasting Plasma Glucose - GDB

Let's start with some useful links:

1.  [From DM2 to FPG (IHME)](https://github.com/ihmeuw/ihme-modeling/blob/master/gbd_2019/risk_factors_code/metab_fpg/crosswalk/dm_2_fpg.R)

2.  [Age-sex splitting for FPG (IHME)](https://github.com/ihmeuw/ihme-modeling/blob/master/gbd_2019/risk_factors_code/metab_fpg/age_sex_split/age_sex_split.R)

## Setting things:

For our project, we will hugely rely on [Pintando e bordando no R](https://datathon-ufrgs.github.io/Pintando_e_Bordando_no_R/#1), by Rodrigo Citton P. dos Reis.

### Packages needed:

We will use **ggplot2** as the main package to generate plots using GBD data and **rnaturalearth** to generate maps.

```{r message=FALSE}
library(ggplot2)
library(ggthemes)
library(plotly)
library(tidyverse)
library(readr)
library(here)
library(rnaturalearth)
library(rnaturalearthdata)
library(rnaturalearthhires)
library(hrbrthemes)
library(shadowtext)
```

### Importing and organizing dataset:

```{r message=FALSE, warning=FALSE}
#From GBD tools
GBD_3 <- readr::read_csv(file = here::here("GBD_3.csv"))
GBD_4 <- readr::read_csv(file = here::here("GBD_4.csv"))
SEV <- readr::read_csv(file = here::here("SEV.csv"))
#Rate of changes
SEV_ROC <- readr::read_csv(file = here::here("SEV_ROC.csv"))
GBD_ROC <- readr::read_csv(file = here::here("GBD_ROC.csv"))
#From GHDx
SDI <- readr::read_csv(file = here::here("GBD_SDI_1990_TO_2019.csv"))

GBD_POP_1990 <- read_csv(file = here::here("GBD_POP_1990.CSV"))
GBD_POP_1991 <- read_csv(file = here::here("GBD_POP_1991.CSV"))
GBD_POP_1992 <- read_csv(file = here::here("GBD_POP_1992.CSV"))
GBD_POP_1993 <- read_csv(file = here::here("GBD_POP_1993.CSV"))
GBD_POP_1994 <- read_csv(file = here::here("GBD_POP_1994.CSV"))
GBD_POP_1995 <- read_csv(file = here::here("GBD_POP_1995.CSV"))
GBD_POP_1996 <- read_csv(file = here::here("GBD_POP_1996.CSV"))
GBD_POP_1997 <- read_csv(file = here::here("GBD_POP_1997.CSV"))
GBD_POP_1998 <- read_csv(file = here::here("GBD_POP_1998.CSV"))
GBD_POP_1999 <- read_csv(file = here::here("GBD_POP_1999.CSV"))
GBD_POP_2000 <- read_csv(file = here::here("GBD_POP_2000.CSV"))
GBD_POP_2001 <- read_csv(file = here::here("GBD_POP_2001.CSV"))
GBD_POP_2002 <- read_csv(file = here::here("GBD_POP_2002.CSV"))
GBD_POP_2003 <- read_csv(file = here::here("GBD_POP_2003.CSV"))
GBD_POP_2004 <- read_csv(file = here::here("GBD_POP_2004.CSV"))
GBD_POP_2005 <- read_csv(file = here::here("GBD_POP_2005.CSV"))
GBD_POP_2006 <- read_csv(file = here::here("GBD_POP_2006.CSV"))
GBD_POP_2007 <- read_csv(file = here::here("GBD_POP_2007.CSV"))
GBD_POP_2008 <- read_csv(file = here::here("GBD_POP_2008.CSV"))
GBD_POP_2009 <- read_csv(file = here::here("GBD_POP_2009.CSV"))
GBD_POP_2010 <- read_csv(file = here::here("GBD_POP_2010.CSV"))
GBD_POP_2011 <- read_csv(file = here::here("GBD_POP_2011.CSV"))
GBD_POP_2012 <- read_csv(file = here::here("GBD_POP_2012.CSV"))
GBD_POP_2013 <- read_csv(file = here::here("GBD_POP_2013.CSV"))
GBD_POP_2014 <- read_csv(file = here::here("GBD_POP_2014.CSV"))
GBD_POP_2015 <- read_csv(file = here::here("GBD_POP_2015.CSV"))
GBD_POP_2016 <- read_csv(file = here::here("GBD_POP_2016.CSV"))
GBD_POP_2017 <- read_csv(file = here::here("GBD_POP_2017.CSV"))
GBD_POP_2018 <- read_csv(file = here::here("GBD_POP_2018.CSV"))
GBD_POP_2019 <- read_csv(file = here::here("GBD_POP_2019.CSV"))

```

```{r message=FALSE, warning=FALSE, results='hide'}

GBD <- GBD_3 %>% 
       bind_rows(GBD_4) %>% 
       bind_rows(SEV)
rm(GBD_3, GBD_4, SEV) #Dont waste my precious RAM

GBD <- GBD %>% 
       mutate(age = recode(age, "80-84" = "80-84 years",
                                "85-89" = "85-89 years",
                                "90-94" = "90-94 years"),
              year = as.factor(year))%>%
       mutate(age = as.factor(age#, levels = c("<5 years",                                                                        "5-9 years",
                                 #             "10-14 years",
                                  #            "15-19 years",
                                   #           "20-24 years",
                                    #          "25-29 years",
                                     #         "30-34 years",
                                      #        "35-39 years",
                                       #       "40-44 years",
                                        #      "45-49 years",
                                         #     "50-54 years",
                                          #    "55-59 years",
                                           #   "60-64 years",
                                            #  "65-69 years",
                                             # "70-74 years",
                                  #            "75-79 years",
                                   #           "80-84 years",
                                    #          "85-89 years",
                                     #         "90-94 years",
                                      #        "95+ years",
                                       #       "All ages",
                                        #      "Age-standardized")
                                )) %>% 
       mutate(measure = recode(measure,
             "YLDs (Years Lived with Disability)" = "YLDs",
             "YLLs (Years of Life Lost)" = "YLLs",
             "DALYs (Disability-Adjusted Life Years)" = "DALYs"),
              location = recode(location,
             "Bolivia (Plurinational State of)" = "Bolivia",
             "Venezuela (Bolivarian Republic of)" = "Venezuela"),
             val_cat = cut(x = GBD$val,
                           breaks = c(-Inf, 1, 10, 100, 500,
                                             1000, 2500, 5000, Inf),
                           labels = c("0 - 1",
                                      "1 - 10",
                                      "10 - 100",
                                      "100 - 500",
                                      "500 - 1000",
                                      "1000 - 2500",
                                      "2500 - 5000",
                                      ">5000")))
       

GBD_POP <-  GBD_POP_1990 %>%
            bind_rows(GBD_POP_2019) %>%
            rename(location = location_name,
                   sex = sex_name,
                   age = age_group_name,
                   year = year_id,
                   pop = val) %>% 
            select(location, sex, age, year, pop) %>%
            mutate(location = recode(location,
                   "Bolivia (Plurinational State of)" = "Bolivia",
                   "Venezuela (Bolivarian Republic of)" = "Venezuela"),
                   sex = recode(sex,
                   "both" = "Both",
                   "male" = "Male",
                   "female" = "Female"),
                   age = as.factor(age),
                   year = as.factor(year))%>%
            filter(location %in% c("Argentina",
                                   "Bolivia",
                                   "Brazil",
                                   "Chile",
                                   "Colombia",
                                   "Ecuador",
                                   "Guyana",
                                   "Paraguay",
                                   "Peru",
                                   "Suriname",
                                   "Uruguay",
                                   "Venezuela")) %>% 
            mutate(age = recode(age,  "Under 5"="<5 years",
                                      "5 to 9"="5-9 years",
                                      "10 to 14"="10-14 years",
                                      "15 to 19"="15-19 years",
                                      "20 to 24"="20-24 years",
                                      "25 to 29"="25-29 years",
                                      "30 to 34"="30-34 years",
                                      "35 to 39"="35-39 years",
                                      "40 to 44"="40-44 years",
                                      "45 to 49"="45-49 years",
                                      "50 to 54"="50-54 years",
                                      "55 to 59"="55-59 years",
                                      "60 to 64"="60-64 years",
                                      "65 to 69"="65-69 years",
                                      "70 to 74"="70-74 years",
                                      "75 to 79"="75-79 years",
                                      "80 to 84"="80-84 years",
                                      "85 to 89"="85-89 years",
                                      "90 to 94"="90-94 years",
                                      "95 plus"="95+ years",
                                      "All Ages" = "All ages")) %>% 
            filter(age %in% c("<5 years",                                                                        "5-9 years",
                              "10-14 years",
                              "15-19 years",
                              "20-24 years",
                              "25-29 years",
                              "30-34 years",
                              "35-39 years",
                              "40-44 years",
                              "45-49 years",
                              "50-54 years",
                              "55-59 years",
                              "60-64 years",
                              "65-69 years",
                              "70-74 years",
                              "75-79 years",
                              "80-84 years",
                              "85-89 years",
                              "90-94 years",
                              "95+ years",
                              "All ages"))
  
rm(GBD_POP_1990,GBD_POP_2019) #Dont waste my precious RAM

SDI <- SDI %>%
          filter(Location %in% c("Argentina",
                 "Bolivia",
                 "Brazil",
                 "Chile",
                 "Colombia",
                 "Ecuador",
                 "Guyana",
                 "Paraguay",
                 "Peru",
                 "Suriname",
                 "Uruguay",
                 "Venezuela")) %>%
          select("Location", "1990", "2019") %>%
          pivot_longer(cols = c("1990", "2019"),
                       names_to = "year",
                       values_to = "SDI")

GBDrates <- GBDrates %>%
            mutate(measure = recode(measure,
            "YLDs (Years Lived with Disability)" = "YLDs",
            "YLLs (Years of Life Lost)" = "YLLs",
            "DALYs (Disability-Adjusted Life Years)" = "DALYs")) %>%
            mutate(location = recode(location,
           "Bolivia (Plurinational State of)" = "Bolivia",
           "Venezuela (Bolivarian Republic of)" = "Venezuela")) %>%
            mutate(year_end = as.factor(year_end)) %>%
            select(-c("rei", "year_start")) %>%
            rename(ROC_val = val, 
                   ROC_upper = upper, 
                   ROC_lower = lower,
                   year = year_end)


SA_map <- ne_countries(scale = "medium",
                   type = "map_units",
                   returnclass = "sf") %>%
      filter(name %in% c("Argentina",
                         "Bolivia",
                         "Brazil",
                         "Chile",
                         "Colombia",
                         "Ecuador",
                         "Guyana",
                         "Paraguay",
                         "Peru",
                         "Suriname",
                         "Uruguay",
                         "Venezuela"))


GBD <- GBD %>%
        full_join(SDI, by = c("location" = "Location", "year" = "year")) %>%
        full_join(GBD_POP, by=c("location"="location",
                                "age"="age",
                                "sex"="sex",
                                "year"="year")) %>% 
        full_join(GBDrates, by=c("location" = "location",
                                 "measure" = "measure",
                                 "sex" = "sex",
                                 "cause" = "cause",
                                 "metric" = "metric",
                                 "year" = "year",
                                 "age" = "age")) %>% 
        mutate(age = recode(age,  "<5 years"="<5",
                                  "5-9 years"="05-09",
                                  "10-14 years"="10-14",
                                  "15-19 years"="15-19",
                                  "20-24 years"="20-24",
                                  "25-29 years"="25-29",
                                  "30-34 years"="30-34",
                                  "35-39 years"="35-39",
                                  "40-44 years"="40-44",
                                  "45-49 years"="45-49",
                                  "50-54 years"="50-54",
                                  "55-59 years"="55-59",
                                  "60-64 years"="60-64",
                                  "65-69 years"="65-69",
                                  "70-74 years"="70-74",
                                  "75-79 years"="75-79",
                                  "80-84 years"="80-84",
                                  "85-89 years"="85-89",
                                  "90-94 years"="90-94",
                                  "95+ years"="95+"))

rm(GBD_POP, SDI, GBDrates) #Dont waste my precious RAM

SA_SUM <- GBD %>%
          filter(metric == "Number",age != "Age-standardized") %>% 
          group_by(measure,sex,age,cause,year) %>% 
          summarise(number = sum(val), pop = sum(pop)) %>% 
          mutate(rate = (number/pop)*100000)
```

### Making graphs:

#### South America(SA)

```{r}

SA_SUM %>%
 filter(sex %in% "Both") %>%
 filter(age %in% "All ages") %>%
 filter(cause %in% "All causes") %>%
 ggplot() +
 aes(x = year, y = number, fill = measure, group = year) +
 geom_col() +
 scale_fill_hue(direction = 1) +
 labs(title = "Number of DALYs, YLDs, YLLs in South America") +
 ggthemes::theme_base() +
 facet_wrap(vars(measure), 
 ncol = 4L)
```

```{r}
SA_SUM %>%
 filter(sex %in% "Both") %>%
 filter(age %in% "All ages") %>%
 filter(cause %in% "All causes") %>%
 ggplot() +
 aes(x = year, y = rate, fill = measure) +
 geom_col() +
 scale_fill_hue(direction = 1) +
 labs(title = "Rate (per 100.000) of DALYs, YLDs, YLLs in South America") +
 ggthemes::theme_base() +
 theme(legend.position = "top") +
 facet_wrap(vars(measure), ncol = 4L)

```

```{r fig.width=15}
SA_SUM %>%
 filter(sex %in% "Both") %>%
 filter(!(age %in% "All ages")) %>%
 filter(cause %in% "All causes") %>%
 ggplot() +
 aes(x = age, y = number, fill = measure) +
 geom_col() +
 scale_fill_hue(direction = 1) +
 labs(title = "Number of DALYs, YLDs, YLLs in South America") +
 ggthemes::theme_base() +
 facet_grid(vars(year), vars(measure))+
 theme(axis.text.x = element_text(hjust = 1,
                                 angle = 45,
                                 size = 10))
```

```{r fig.width=15}
SA_SUM %>%
 filter(sex %in% "Both") %>%
 filter(!(age %in% "All ages")) %>%
 filter(cause %in% "All causes") %>%
 ggplot() +
 aes(x = age, y = number, fill = measure) +
 geom_col() +
 scale_fill_hue(direction = 1) +
 labs(title = "Number of DALYs, YLDs, YLLs in South America") +
 ggthemes::theme_base() +
 theme(legend.position = "top") +
  facet_grid(vars(year), vars(measure))+
 theme(axis.text.x = element_text(hjust = 1,
                                 angle = 45,
                                 size = 10))
```

```{r fig.width=15}
SA_SUM %>%
 filter(sex %in% "Both") %>%
 filter(!(age %in% "All ages")) %>%
 filter(cause %in% "All causes") %>%
 ggplot() +
 aes(x = age, y = rate, fill = measure) +
 geom_col() +
 scale_fill_hue(direction = 1) +
 labs(title = "Rate (per 100.000) of DALYs, YLDs, YLLs in South America") +
 ggthemes::theme_base() +
 theme(legend.position = "top") +
 facet_grid(vars(year), vars(measure))+
   theme(axis.text.x = element_text(hjust = 1,
                                 angle = 45,
                                 size = 10))
```

```{r}
p <- GBD %>%
      filter (cause == "All causes", metric == "Rate",
              measure != "DALYs", measure != "Deaths",
              age == "Age-standardized") 

ggplot(p) +
  aes(x = year, fill = measure, weight = val) +
  geom_bar(width = 1) +
  labs(x = "", y = "DALYs per 100.000", fill = "",
       title = "Rate of DALYs by location, sex and year") +
  ggthemes::theme_base() +
  facet_grid(vars(sex), vars(location))+
  theme(
      axis.text.x = element_text(hjust = 1,
                                 angle = 45,
                                 size = 8),
      axis.text.y = element_text(hjust = 0,5,
                                 angle = 0,
                                 size = 8),
      strip.text.x = element_text(
                                 angle = 45,
                                 size = 8),
      strip.text.y = element_text(hjust = 0.8, size = 8),
          
      panel.background = element_blank(),
      panel.border = element_blank())+
  

  coord_cartesian(ylim = c(0,7000))

rm(p)
      
```

```{r}


p <- GBD %>%
     filter(cause == "All causes") %>%
     filter(metric == "Rate") %>% 
     filter(age == "Age-standardized")
    
    
ggplot()+
    geom_line(data = p %>% filter (measure == "DALYs"),
              aes(x = year, y = val,
                  color = measure, group = measure))+
    geom_line(data = p %>% filter (measure == "YLDs"),
              aes(x = year, y = val,
                  color = measure, group = measure))+
    geom_line(data = p %>% filter (measure == "YLLs"),
              aes(x = year, y = val,
                  color = measure, group = measure))+
    geom_point(data = p %>% filter (measure == "DALYs"),
              aes(x = year, y = val,
                  color = measure, group = measure))+
    geom_point(data = p %>% filter (measure == "YLDs"),
              aes(x = year, y = val,
                  color = measure, group = measure))+
    geom_point(data = p %>% filter (measure == "YLLs"),
              aes(x = year, y = val,
                  color = measure, group = measure))+
    facet_grid(vars(sex), vars(location))+
   theme_minimal() +
    theme(
        axis.text.x = element_text(hjust = 1,
                                   angle = 45,
                                   size = 8),
        axis.text.y = element_text(hjust = 0,5,
                                   angle = 0,
                                   size = 8),
        strip.text.x = element_text(
                                   angle = 45,
                                   size = 8),
        strip.text.y = element_text(hjust = 0.8, size = 8),
            
        panel.background = element_blank(),
        panel.border = element_blank())+
    

    coord_cartesian(ylim = c(0,7000))+
    labs(x = "", y = "Measure per 100.000", fill = "Measure",
           title = "Rate of DALYs, YLDs and YLLs by location, sex and year")

rm(p)
```

#### Heatmaps...

```{r fig.width=10}
p <- GBD %>% 
      filter (metric =="Rate", year == "2019", sex == "Both",
              measure == "DALYs", age == "Age-standardized")
      
  
  
  ggplot(p, mapping = aes(x = location, y = cause, fill = val_cat))+
      geom_tile(color = "white", lwd = 0)+
     
      geom_shadowtext(aes(label = round(val, digits = 0)), color = "white",
                size = 2.3) +
      scale_fill_viridis_d(direction = -1)+
      ggthemes::theme_base() +
      
      labs(title = "DALYs per 100.000 for each cause
           by country in 2019, both sexes", fill = "DALYs per 100.000",
           x = "", y= "")+
            theme(
              axis.text.x = element_text(hjust = 1,
                                         angle = 45,
                                         size = 8),
              plot.title = element_text(hjust = 0.9))
  
rm(p)
  
  
  
```

```{r fig.height=15, fig.width=15}
p <- GBD %>% 
      filter (metric =="Rate", sex == "Both", age == "Age-standardized")
    
  
ggplot()+
geom_tile(data = p, 
          mapping = aes(x = location, 
                        y = cause, 
                        fill = val_cat),
          color = "white")+
geom_shadowtext(data = p,
                aes(x = location,
                    y = cause,
                    label = round(val, digits = 0)),
                color = "white",
                size = 2.3) +
facet_grid(vars(year), vars(measure))+
scale_fill_viridis_d(direction = -1)+
ggthemes::theme_base() +
coord_fixed(ratio = 1)+
labs(title = "DALYs, YLDs, YLLs and deaths related to HFPG per 100.000 by cause for South America countries in 1990 and 2019", 
     fill = "Measure per 100.000", y = "", x = "")+
theme(axis.text.x = element_text(hjust = 1,
                                 angle = 45,
                                 size = 6),
      plot.title = element_text(hjust = 0.5),
      title = element_text(size = 7))
rm(p)
```

```{r}
p <- GBD %>%
 filter(measure == "DALYs") %>%
 filter(sex == "Both") %>%
 filter(cause == "All causes") %>%
 filter(metric == "Rate") %>%
 filter(year == "2019") %>%
 filter(age == "Age-standardized")
 
ggplot(p, aes(x = SDI, y = ROC_val)) +
  geom_point(aes(fill = location,
                 colour = location),
             size = 3) +
  scale_fill_hue(direction = 1) +
  scale_color_hue(direction = 1) +
  geom_hline(yintercept = 0, colour = "gray")+
  ggthemes::theme_base() +
  labs(y = "DALYs anual rate of change in 1990-2019(%)",
       x = "SDI in 2019")

rm(p)
```

Let's start with a map of South America

```{r}
p <- GBD %>% filter(sex == "Both",
               cause == "All causes",
               age == "Age-standardized",
               metric != "Percent")

q <- SA_map %>% 
     full_join(p, by = c("admin"="location"))

ggplot()+
  geom_sf(data = q %>% filter(metric == "Number",
                              measure == "DALYs"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "DALYs Number")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Number",
                              measure == "YLDs"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "YLDs Number")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Number",
                              measure == "YLLs"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "YLLs Number")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Number",
                              measure == "Deaths"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "Deaths Number")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Number",
                              measure == "DALYs"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "DALYs rate")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Rate",
                              measure == "YLDs"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "YLDs rate")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Rate",
                              measure == "YLLs"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "YLLs rate")

ggplot()+
  geom_sf(data = q %>% filter(metric == "Rate",
                              measure == "Deaths"), aes(fill = val))+
  coord_sf(xlim = c(-35,-85))+
  theme_classic()+
  labs(title = "Deaths rate")

```

```{r}

```

```{r}

```
